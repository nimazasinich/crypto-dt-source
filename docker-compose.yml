version: '3.8'

services:
  crypto-monitor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: crypto-api-monitor
    image: crypto-api-monitor:latest

    # Port mapping (HuggingFace Spaces standard port)
    ports:
      - "7860:7860"

    # Environment variables
    environment:
      - PYTHONUNBUFFERED=1
      - ENABLE_SENTIMENT=true
      - HF_REGISTRY_REFRESH_SEC=21600
      - HF_HTTP_TIMEOUT=8.0
      # Add your HuggingFace token here or via .env file
      # - HUGGINGFACE_TOKEN=your_token_here

      # Sentiment models (optional customization)
      - SENTIMENT_SOCIAL_MODEL=ElKulako/cryptobert
      - SENTIMENT_NEWS_MODEL=kk08/CryptoBERT

    # Optional: Load environment variables from .env file
    env_file:
      - .env

    # Volume mounts for data persistence
    volumes:
      # Persist SQLite database
      - ./data:/app/data

      # Persist logs
      - ./logs:/app/logs

      # Optional: Mount config for live updates during development
      # - ./config.py:/app/config.py
      # - ./all_apis_merged_2025.json:/app/all_apis_merged_2025.json

      # Optional: Mount frontend files for live updates
      # - ./index.html:/app/index.html
      # - ./hf_console.html:/app/hf_console.html
      # - ./config.js:/app/config.js

    # Health check configuration
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7860/health"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

    # Restart policy
    restart: unless-stopped

    # Resource limits (adjust based on your system)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

    # Network configuration
    networks:
      - crypto-network

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Network definition
networks:
  crypto-network:
    driver: bridge
    name: crypto-monitor-network

# Volume definitions (optional - for named volumes instead of bind mounts)
volumes:
  crypto-data:
    name: crypto-monitor-data
  crypto-logs:
    name: crypto-monitor-logs
